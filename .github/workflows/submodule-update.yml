name: Update Submodules

on:
  workflow_dispatch: {}
  schedule:
    - cron: "0 3 * * *"

jobs:
  update-submodules:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0

      - run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CHANGELOG=""
          UPDATED=false

          for module in $(git config -f .gitmodules --get-regexp path | awk '{print $2}'); do
            url=$(git config -f .gitmodules submodule.$module.url)

            if [[ $url =~ github.com[:/](.*)\.git$ ]]; then
              repo="${BASH_REMATCH[1]}"
            else
              continue
            fi

            latest=$(gh release view -R "$repo" --json tagName --jq .tagName 2>/dev/null || echo "")
            [ -z "$latest" ] && continue

            pushd "$module" >/dev/null
            current=$(git describe --tags --abbrev=0 2>/dev/null || echo "NONE")

            if [ "$current" != "$latest" ]; then
              git fetch --tags
              git checkout "$latest"
              CHANGELOG+="$module: $current -> $latest\n"
              UPDATED=true
            fi
            popd >/dev/null
          done

          echo -e "$CHANGELOG" > changelog.txt
          echo "changed=$UPDATED" >> $GITHUB_OUTPUT

          $UPDATED && git add .

      - uses: peter-evans/create-pull-request@v7
        if: steps.check.outputs.changed == 'true'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "Update submodules to latest GitHub releases"
          title: "Update submodules to latest GitHub releases"
          body: |
            Updated submodules to latest GitHub releases:

            ```
            $(cat changelog.txt)
            ```
          branch: update-submodules
          base: main
          delete-branch: true
